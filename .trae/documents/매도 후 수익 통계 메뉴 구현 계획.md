## 개요
- 목표: 매도 완료 후 수익 관련 통계를 한 곳에서 제공하는 신규 메뉴(탭)를 추가하고, 기본·고급 분석과 보고서 출력, 실시간 갱신·필터링을 지원
- 스택: React + TypeScript + Vite, Tailwind, Recharts 사용. 데이터는 App 상태와 Google Drive 저장/로드를 활용
- 기존 기반: 매도 데이터 구조(`SellTransaction`)와 매도 처리, 손익/포트폴리오 히스토리 및 Recharts 기반 라인차트가 이미 일부 존재

## 현재 코드베이스 기반 요소
- 매도 기록 생성: `SellAssetModal.tsx:76`에서 환율을 포함해 매도 트랜잭션 생성 파라미터를 전달, `App.tsx:670-725`에서 `sellTransactions`으로 누적 저장
- 기본 매도 통계(합계·수익률): `App.tsx:1002-1043`의 `soldAssetsStats` 메모에서 총 매도금액/매수금액/수익/수익률 계산
- 손익 추이(라인차트): `components/ProfitLossChart.tsx`는 포트폴리오 평가 손익을 일자별로 그리는 라인 차트
- 포트폴리오 히스토리: `App.tsx:360-411`에서 일별 평가 스냅샷 생성·보관(최대 365일)

## 정보 구조·정합성 설계
- 실현손익(Realized PnL): 거래별 실현손익 = `sellPrice*sellQuantity - 구매원가KRW(sellQuantity)`로 정의(구매원가KRW는 `purchaseExchangeRate` 또는 당시 환산 비율로 산출). 현재 로직과 일관 유지(`App.tsx:1016-1027`)
- 통화·환율: `SellAssetModal`에서 매도일 환율을 우선 취득(`SellAssetModal.tsx:50-76`), 실패 시 안전한 대안 사용. 모든 통계는 KRW 기준으로 수치 통일
- 기간 집계: 일/주/월/분기 단위로 실현손익을 그룹화하여 합계·누적·평균 수익률을 산출. 포맷팅과 로케일 `ko-KR` 유지(`ProfitLossChart.tsx`와 동일 스타일)
- 정확도 99.9%: 반올림/포맷팅 분리, 비용/수익 계산에서 부동소수 오차 최소화를 위해 정밀도 제어 및 단위 테스트 추가(Phase 4)

## 신규 탭·화면 구성
- 상단 탭에 ‘수익 통계’ 추가(`App.tsx:1264-1267` 영역 확장, `ActiveTab`에 `analytics` 추가 `App.tsx:21`)
- 페이지 컴포넌트: `SellAnalyticsPage.tsx`
  - 개요 카드: 총 매도금액, 순수익, 누적 수익률, 매도 횟수(기존 `StatCard` 스타일 재사용)
  - 기간별 수익 추이: 일/주/월/분기 라인 차트 토글(‘Recharts’ 기반: `LineChart`/`ResponsiveContainer` 패턴 재사용)
  - 종목별 수익률 순위: 테이블 + 바 차트(상위 N/하위 N), 정렬·검색 지원
  - 손익 분포 히스토그램: 거래별 실현손익을 구간화하여 분포 시각화(도수·구간 폭 설정 UI)
  - 사용자 필터 패널: 기간(시작/끝), 종목(티커/카테고리), 계좌(옵션), 최소 거래금액/수익률
  - 실시간 갱신 배지/버튼: 자산 가격 갱신과 연동해 재계산(기존 `handleRefreshAllPrices` 사용)

## 고급 분석 모듈
- 변동성 지표: 기간별 실현 ‘수익률’ 시계열 표준편차 계산, 연율화 옵션 제공
- 베타: 시장 지수 대비 포트폴리오 일별 ‘평가수익률’ 베타(공분산/분산). 소스 데이터는:
  - 포트폴리오: `portfolioHistory` 일별 평가금액으로 수익률 산출
  - 시장 지수: 선택형(코스피 `^KS11`, S&P500 `^GSPC`)의 일별 종가 시계열
  - 데이터 획득 경로: (A) CSV 업로드(권장 안정성), (B) 향후 `geminiService` 확장으로 최근 N일 지수 시계열 취득(캐시·검증 포함)
- 시장대비 상대수익률: 동일 기간 포트폴리오 수익률 – 시장 수익률의 라인 차트 및 통계 테이블
- 매도 타이밍 백테스트: 선택 종목에 대해 단순 규칙(이동평균 크로스, 트레일링 스탑, %목표가)을 과거 시계열에 적용해 대안 매도 시점의 성과 비교. 입력: 기준 기간·룰 파라미터. 출력: 대안 실현손익/히트맵·표
- 위험조정 수익률: 샤프(초과수익/표준편차), 소르티노(초과수익/하방편차). 무위험수익률은 기본값(예: 연 3% KRW) 또는 사용자 설정

## 시스템 요구·아키텍처 대응
- 반응형: Tailwind의 그리드/반응형 클래스 재사용(현 컴포넌트들과 동일 패턴). 차트 컨테이너는 `ResponsiveContainer` 활용
- 실시간 갱신: 자산·히스토리 상태 변경 시 통계 메모 재계산(`useMemo`/`useEffect`), 자동 저장·갱신과 연동
- 보고서 출력: 
  - CSV: 기존 내보내기 로직 확장(분석 결과 전용 CSV), 문자열 이스케이프 로직 재사용(`App.tsx:1099-1106`)
  - Excel: 라이브러리 추가 후(예: `xlsx`) 데이터 프레임을 시트로 출력(Phase 3에서 도입)
- 사용자 정의 필터: 기간/종목/계좌·카테고리 필터 UI. 계좌 필드는 `Asset`에 선택 속성으로 확장 계획(Phase 1.5 또는 Phase 3)

## 성능·품질 기준 달성 전략
- 3초 응답: 비용 높은 연산은 메모이제이션, 가벼운 샘플링·지연 계산, 차트 데이터 페이징
- 1,000 TPS 대응: 렌더·계산 분리, Web Worker(필요 시), 연속 입력 디바운스, 큰 테이블 가상 스크롤 도입
- 정확성 99.9%: 정밀도 제어(소수 처리), 통화/환율 일관, 단위·통합 테스트로 검증. 예외·결측 처리 체계화
- 크로스브라우저: 최신 Recharts/Tailwind 조합은 Chrome/Firefox/Safari 호환. CSS·API 사용 범위 점검

## 구현 상세(파일 중심)
- `App.tsx`
  - `ActiveTab`에 `analytics` 추가 및 탭 버튼/라우팅 확장
  - `soldAssetsStats`를 공용 훅/유틸로 분리하여 새 페이지에서 재사용
  - 지수 데이터 소스 설정 상태 및 캐시 도입(선택된 시장 지수, CSV 업로드 핸들러)
- `components/SellAnalyticsPage.tsx`
  - 레이아웃/필터 패널/통계 카드/차트·테이블 영역 구성
- `components/SellProfitTrendChart.tsx`
  - 기간 그룹화 토글(일/주/월/분기), 선형/누적 옵션
- `components/ReturnsRanking.tsx`
  - 종목별 실현수익률 계산·정렬·바 차트 동시 제공
- `components/PnLHistogram.tsx`
  - 거래별 PnL 구간화 및 도수 계산, 막대 히스토그램 렌더링
- `components/AdvancedMetricsPanel.tsx`
  - 변동성/베타/샤프/소르티노 계산과 결과 표시
- `services/indexDataService.ts`
  - (옵션) 시장 지수 시계열 로더: CSV 파서 또는 `geminiService` 확장 래퍼

## 테스트·검증
- 단위 테스트: 실현손익·기간 집계·변동성·샤프/소르티노 계산 함수에 대해 경계값/다통화/환율 실패 케이스 포함
- 시각화 스냅샷: 주요 차트 데이터 생성 함수를 스냅샷 테스트로 검증
- 성능 측정: 더미 대용량 거래 데이터로 렌더 성능 측정, 메모이제이션 효과 확인

## 개발 로드맵(요구사항 매핑)
- 1단계(2주): 기본 통계 모듈/새 탭/기간별 추이/순위/히스토그램 + CSV 출력
- 2단계(1주): 시각화 컴포넌트 고도화(토글·툴팁·줌·반응형 최적화)
- 3단계(2주): 고급 분석(변동성·베타·시장대비·타이밍 백테스트·샤프/소르티노) + Excel 출력 +(옵션) 계좌 필드
- 4단계(1주): 테스트·정확성/성능 최적화·크로스브라우저 점검·문서화(사용법 패널)

## 리스크·대안
- 시장 지수 시계열 신뢰성: CSV 업로드 우선, 추후 자동 수집은 캐시·검증·폴백 포함
- 베타/타이밍 분석의 데이터 의존성: 자산·지수의 충분한 기간 데이터가 없으면 기능 안내·비활성화 처리

## 승인 후 바로 착수 변경점 요약
- 새 탭 추가와 `SellAnalyticsPage` 생성
- 기존 `soldAssetsStats`/히스토리·환율 로직을 재사용한 실현손익 집계·시각화 구현
- 필터 UI 및 CSV 내보내기 우선 제공, Excel은 Phase 3에 도입